<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> MeanFlows | Tenacious life, proud journey. </title> <meta name="author" content="P W Name"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; media-src 'self' https:; frame-src 'self' https:; connect-src 'self' https:;"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?v=a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?v=f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?v=62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?v=591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?v=6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?v=d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://beyondpzk.github.io/blog/2025/MeanFlows/"> <script src="/assets/js/theme.js?v=5fea5159b787642c1bbc1f334d60f883"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?v=5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> Tenacious life, proud journey. </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/people/">people </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/books/">bookshelf</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="fa-solid fa-magnifying-glass"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-half-sun-moon" id="light-toggle-system"></i> <i class="fa-solid fa-moon" id="light-toggle-dark"></i> <i class="fa-solid fa-sun" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">MeanFlows</h1> <p class="post-meta"> Created on May 19, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/category/aigc"> <i class="fa-solid fa-tag fa-sm"></i> AIGC</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>[TOC]</p> <h1 id="meanflows">meanflows</h1> <ul> <li><a href="https://arxiv.org/abs/2505.13447" rel="external nofollow noopener" target="_blank">paper地址</a></li> </ul> <p>我的理解: 我觉得meansflows是针对 rectified flow的弱点来的,尤其是训练时的弱点.</p> <p>基于论文内容，MeanFlow 的训练目标、Loss 函数以及 Ground Truth (GT) 的构建方式非常独特。它不像传统的监督学习那样直接有一个固定的“标签”，而是通过一个<strong>微分恒等式</strong>构造了一个<strong>自洽（Self-consistent）的回归目标</strong>。</p> <p>以下是详细的数学原理和步骤解析：</p> <h3 id="1-核心理论基础meanflow-identity">1. 核心理论基础：MeanFlow Identity</h3> <p>理解 Loss 的前提是理解论文推导出的核心公式——<strong>MeanFlow Identity（平均流恒等式）</strong>。</p> <ul> <li> <strong>定义：</strong> <ul> <li>$v(z_t, t)$：瞬时速度（Instantaneous Velocity）. (我的理解是最终要学到的速度场 $v$ 在 $t$ 时刻, 位置 $z_t$ 时的值.)</li> <li>$u(z_t, r, t)$：平均速度（Average Velocity），即从时间 $r$ 到 $t$ 的位移除以时间间隔。</li> </ul> </li> <li> <p><strong>恒等式：</strong> 论文推导出 $u$ 和 $v$ 必须满足以下微分关系（论文公式 6）： \(\frac{d}{dt} u(z_t, r, t) = \frac{v(z_t, t) - u(z_t, r, t)}{t - r}\)</p> <p><strong>移项后，我们可以得到 $u$ 的表达式：</strong> \(u(z_t, r, t) = v(z_t, t) - (t - r) \underbrace{\frac{d}{dt} u(z_t, r, t)}_{\text{全导数}}\)</p> <p><strong>这个移项后的公式，就是训练目标的来源。</strong></p> </li> </ul> <hr> <h3 id="2-训练目标-regression-target-与-gt-构建">2. 训练目标 (Regression Target) 与 GT 构建</h3> <p>MeanFlow 的训练本质上是训练神经网络 $u_\theta$ 去拟合上述恒等式的右边。</p> <h4 id="ground-truth-gt-的构成u_texttgt">Ground Truth (GT) 的构成：$u_{\text{tgt}}$</h4> <p>训练时的“目标值” $u_{\text{tgt}}$ 并不是预先计算好的固定值，而是由<strong>已知物理量</strong>和<strong>网络当前的导数预测</strong>动态组合而成的。</p> <p>根据论文公式 (10) 和 (11)，目标值 $u_{\text{tgt}}$ 定义为：</p> \[u_{\text{tgt}} = \underbrace{v_t}_{\text{数据决定的瞬时速度}} - (t - r) \times \underbrace{\left( v_t \cdot \nabla_z u_\theta + \partial_t u_\theta \right)}_{\text{网络预测的全导数 (JVP)}}\] <p>这里包含两个关键部分：</p> <ol> <li> <strong>$v_t$ (瞬时速度，真正的 Ground Truth 来源)：</strong> <ul> <li>这是唯一来自数据的外部信号。</li> <li>在 Flow Matching 框架下，对于一条直线路径（Straight Path），给定数据点 $x$（图片）和噪声 $\epsilon$，在时间 $t$ 的位置是 $z_t = (1-t)x + t\epsilon$。</li> <li>此时的<strong>条件瞬时速度</strong>是已知的：<strong>$v_t = \epsilon - x$</strong> (或者 $x - \epsilon$，取决于具体定义，论文中 $v_t = \epsilon - x$ 对应 $z_1=\epsilon, z_0=x$)。</li> <li> <strong>注意：</strong> 这个 $v_t$ 不需要模型预测，是直接算出来的。</li> </ul> </li> <li> <strong>全导数项 (网络自身的性质)：</strong> <ul> <li>$\frac{d}{dt} u$ 被展开为 $\frac{\partial u}{\partial z} \frac{dz}{dt} + \frac{\partial u}{\partial t}$。</li> <li>其中 $\frac{dz}{dt}$ 就是 $v_t$。</li> <li>这一项通过 <strong>Jacobian-Vector Product (JVP)</strong> 计算。即计算网络输出 $u_\theta$ 对输入 $(z, r, t)$ 的导数，并沿着向量 $(v_t, 0, 1)$ 方向投影。</li> </ul> </li> </ol> <h4 id="stop-gradient-停止梯度">Stop-Gradient (停止梯度)</h4> <p>为了避免训练不稳定和二阶导数计算（Double Backpropagation），论文对目标值使用了 <strong>Stop-Gradient (sg)</strong> 操作： \(\text{Target} = \text{sg}(u_{\text{tgt}})\) 这意味着在计算 Loss 对网络参数 $\theta$ 的梯度时，<strong>不</strong>对 $u_{\text{tgt}}$ 里的 $u_\theta$ 求导。目标值被视为一个常数。</p> <hr> <h3 id="3-loss-函数">3. Loss 函数</h3> <p>论文使用的 Loss 函数形式如下（公式 9）：</p> \[\mathcal{L}(\theta) = \mathbb{E}_{t, r, x, \epsilon} \left[ \| u_\theta(z_t, r, t) - \text{sg}(u_{\text{tgt}}) \|^2 \right]\] <p><strong>详细展开后：</strong></p> \[\mathcal{L}(\theta) = \| u_\theta(z_t, r, t) - \text{sg}\left( v_t - (t-r)(\underbrace{v_t \cdot \nabla_z u_\theta + \partial_t u_\theta}_{\text{JVP}}) \right) \|^2\] <p><strong>Loss 的直观解释：</strong></p> <ul> <li>网络预测的平均速度 $u_\theta$，应该等于“瞬时速度 $v_t$”减去“因时间变化导致的修正项”。</li> <li>如果 $t=r$，则 $t-r=0$，Loss 变为 $| u_\theta - v_t |^2$，这退化为标准的 Flow Matching（平均速度等于瞬时速度）。</li> <li>如果 $t \neq r$，模型就被迫学习如何根据当前的瞬时速度和变化率，去推断跨越时间段的平均速度。</li> </ul> <p><strong>加权 Loss (Adaptive Weighting):</strong> 在实际训练中（Section 4.3），为了平衡不同时间步的学习难度，作者使用了一个自适应权重 $w$： \(\mathcal{L}_{\text{final}} = w \cdot \| \Delta \|^2\) 其中 $w = \frac{1}{| \Delta |^2 + c}$（$c$ 是小常数），这使得 Loss 表现得像 Pseudo-Huber Loss，能提高训练稳定性。</p> <hr> <h3 id="4-训练流程总结-step-by-step">4. 训练流程总结 (Step-by-Step)</h3> <p>根据论文 Algorithm 1，一步训练的具体操作如下：</p> <ol> <li> <strong>采样时间：</strong> 随机采样两个时间点 $t$ 和 $r$（通常 $t, r \in [0, 1]$，且 $t &gt; r$）。</li> <li> <strong>采样数据：</strong> 采样一张真实图片 $x$ 和高斯噪声 $\epsilon$。</li> <li> <strong>构造输入 $z_t$：</strong> 使用线性插值构造当前时刻的噪声图：$z_t = (1-t)x + t\epsilon$。</li> <li> <strong>计算瞬时速度 $v_t$：</strong> 直接计算 $v_t = \epsilon - x$。这是物理真值。</li> <li> <strong>前向传播与 JVP：</strong> <ul> <li>将 $(z_t, r, t)$ 输入网络 $u_\theta$。</li> <li>同时利用自动微分框架（如 PyTorch 的 <code class="language-plaintext highlighter-rouge">torch.func.jvp</code>）计算全导数 $dudt = \text{jvp}(u_\theta, (z_t, r, t), (v_t, 0, 1))$。</li> </ul> </li> <li> <strong>构建目标 $u_{\text{tgt}}$：</strong> 计算 $u_{\text{tgt}} = v_t - (t - r) \times dudt$。</li> <li> <strong>计算 Loss：</strong> 计算预测值 $u$ 和目标值 $\text{sg}(u_{\text{tgt}})$ 之间的加权平方误差。</li> <li> <strong>反向传播：</strong> 更新网络参数 $\theta$。</li> </ol> <h3 id="5-特殊情况带-cfg-的-gt-构建">5. 特殊情况：带 CFG 的 GT 构建</h3> <p>如果使用 Classifier-Free Guidance (CFG)，GT 会发生变化（Section 4.2）：</p> <ul> <li> <strong>目标场变化：</strong> 目标不再是单纯的 $v_t$，而是混合了 CFG 权重的速度场。</li> <li> <strong>公式：</strong> $u_{\text{tgt}}$ 中的 $v_t$ 被替换为 $\tilde{v}<em>t = \omega v_t + (1-\omega) u</em>{\theta}(z_t, t, t)$。</li> <li>这意味着在训练阶段，模型不仅要拟合物理速度，还要拟合“被引导后”的速度场，从而使得推理时只需 1 步即可完成 CFG 生成。</li> </ul> <p>下面是详细解释.</p> <h1 id="cfg-的gt构建">CFG 的GT构建</h1> <p>关于 <strong>带 CFG（Classifier-Free Guidance）的 Ground Truth (GT) 构建</strong>，这是 MeanFlow 论文中非常精彩的一部分，因为它巧妙地解决了传统 CFG 推理速度慢的问题。</p> <p>以下是关于带 CFG 的 GT 构建的详细完整解读：</p> <hr> <h3 id="1-核心思想把-cfg-内化到训练目标中">1. 核心思想：把 CFG “内化”到训练目标中</h3> <ul> <li> <p><strong>传统 CFG 的痛点：</strong> 在采样（推理）阶段，传统方法需要计算公式：$\text{Output} = \text{Uncond} + \omega (\text{Cond} - \text{Uncond})$。这意味着每生成一步，都要跑两次网络（一次有条件，一次无条件），导致计算量翻倍（2-NFE）。</p> </li> <li> <p><strong>MeanFlow 的解决方案：</strong> 作者定义了一个新的<strong>混合物理场</strong> $v_{\text{cfg}}$。既然我们知道推理时想要的是混合后的结果，不如直接训练网络去预测这个<strong>已经混合好的平均速度</strong> $u_{\text{cfg}}$。这样推理时只需要跑一次网络（1-NFE）。</p> </li> </ul> <hr> <h3 id="2-构造新的混合瞬时速度-tildev_t">2. 构造新的“混合瞬时速度” ($\tilde{v}_t$)</h3> <p>在普通训练中，瞬时速度的 GT 是 $v_t = \epsilon - x$。 在 CFG 训练中，我们需要构造一个<strong>混合了引导尺度的瞬时速度</strong> $\tilde{v}_t$ 作为基础。</p> <p>根据论文公式 (13) 和 (19)，新的瞬时速度定义为：</p> \[\tilde{v}_t = \omega \cdot v_t + (1 - \omega) \cdot u_\theta(z_t, t, t)\] <p>这里包含三部分：</p> <ol> <li> <strong>$\omega$ (Guidance Scale)：</strong> 引导强度（例如 2.0 或 7.5），这是训练时的超参数。</li> <li> <strong>$v_t$ (Conditional Velocity)：</strong> 数据决定的物理真值（即 $\epsilon - x$）。这代表了“有条件”的理想方向。</li> <li> <strong>$u_\theta(z_t, t, t)$ (Unconditional Velocity)：</strong> <strong>这是关键点。</strong> <ul> <li>当 $r=t$ 时，平均速度等于瞬时速度。</li> <li>这里使用<strong>模型自己预测的</strong>、在 $t$ 时刻的瞬时速度，来近似“无条件”的速度场。</li> <li>注意：这一项通常是把类别条件置空（Drop Condition）后得到的输出。</li> </ul> </li> </ol> <p><strong>直观理解：</strong> 训练目标不再是纯粹的物理真实速度，而是“物理真实速度”和“模型自己认为的无条件速度”的一个线性组合。</p> <hr> <h3 id="3-构造带-cfg-的训练目标-u_texttgt">3. 构造带 CFG 的训练目标 ($u_{\text{tgt}}$)</h3> <p>有了上面的 $\tilde{v}<em>t$，我们再次利用 <strong>MeanFlow Identity</strong> 来构造最终的回归目标 $u</em>{\text{tgt}}$。</p> <p>公式 (18) 如下：</p> \[u_{\text{tgt}} = \tilde{v}_t - (t - r) \times \underbrace{\left( \tilde{v}_t \cdot \nabla_z u^{\text{cfg}}_\theta + \partial_t u^{\text{cfg}}_\theta \right)}_{\text{基于 } \tilde{v}_t \text{ 计算的 JVP}}\] <p><strong>具体步骤变化：</strong></p> <ol> <li> <strong>计算 JVP 时：</strong> 投影向量不再是 $(v_t, 0, 1)$，而是变成 $(\tilde{v}_t, 0, 1)$。这意味着我们计算的是沿着 CFG 混合轨迹的导数。</li> <li> <strong>计算目标值时：</strong> 基准速度变成了 $\tilde{v}_t$。</li> </ol> <hr> <h3 id="4-进阶技巧improved-cfg-appendix-b1">4. 进阶技巧：Improved CFG (Appendix B.1)</h3> <p>论文在附录中提出了一个改进版（Improved CFG），引入了一个混合参数 $\kappa$，进一步提升了效果。</p> <p><strong>问题：</strong> 基础版公式只利用了“无条件”的模型输出。 <strong>改进：</strong> 作者认为应该同时混合“有条件”和“无条件”的模型输出到目标中。</p> <p><strong>改进后的混合瞬时速度公式 (Eq. 21)：</strong></p> \[\tilde{v}_t = \omega (\epsilon - x) + \kappa \cdot u_\theta(z_t, t, t | c) + (1 - \omega - \kappa) \cdot u_\theta(z_t, t, t | \emptyset)\] <ul> <li> <table> <tbody> <tr> <td>**$u_\theta(z_t, t, t</td> <td>c)$：** 模型预测的<strong>有条件</strong>瞬时速度。</td> </tr> </tbody> </table> </li> <li> <table> <tbody> <tr> <td>**$u_\theta(z_t, t, t</td> <td>\emptyset)$：** 模型预测的<strong>无条件</strong>瞬时速度。</td> </tr> </tbody> </table> </li> <li> <strong>$\kappa$：</strong> 一个新的超参数，用于调节混合比例。</li> </ul> <p><strong>为什么这样做？</strong> 这相当于一种<strong>自蒸馏 (Self-Distillation)</strong>。模型在训练过程中，不仅在学习拟合数据（$\epsilon - x$），还在学习拟合“自己之前的预测混合”。这使得模型预测的平均速度场 $u_{\text{cfg}}$ 更加平滑、一致，从而在单步生成时画质更好。</p> <hr> <h3 id="5-总结带-cfg-的训练与推理">5. 总结：带 CFG 的训练与推理</h3> <h4 id="训练阶段-training">训练阶段 (Training)</h4> <ol> <li>随机采样 $t, r, x, \epsilon$。</li> <li>计算物理速度 $v_t = \epsilon - x$。</li> <li>让模型预测当前的瞬时速度 $u_{\text{inst}} = u_\theta(z_t, t, t)$（可能包含有条件和无条件两次前向）。</li> <li> <strong>合成目标速度场：</strong> $\tilde{v}<em>t = \text{Mix}(v_t, u</em>{\text{inst}}, \omega)$。</li> <li> <strong>计算 JVP：</strong> 基于 $\tilde{v}_t$ 计算全导数。</li> <li> <strong>计算 Loss：</strong> $| u_\theta(z_t, r, t) - \text{sg}(u_{\text{tgt}}) |^2$。</li> </ol> <h4 id="推理阶段-inference--sampling">推理阶段 (Inference / Sampling)</h4> <p><strong>极度简单：</strong> 因为模型 $u_\theta$ 已经学会了预测“混合后的平均速度”，所以推理时<strong>不需要</strong>做任何 CFG 公式计算，也不需要跑两次模型。</p> \[z_0 = z_1 - (1 - 0) \cdot u_\theta(z_1, 0, 1 | c)\] <p><strong>只需 1 次 NFE，就能得到带 Guidance 效果的高质量图像。</strong></p> <h2 id="平均流恒等式的推导">平均流恒等式的推导</h2> <p>接下来详细推导 <strong>MeanFlow Identity（平均流恒等式）</strong>。这是整篇论文的理论基石，它建立起了“平均速度”与“瞬时速度”之间的微分关系。(我把它理解为宏观速度场与微观粒子间速度的关系)</p> <hr> <h3 id="1-符号定义">1. 符号定义</h3> <p>首先，我们需要明确几个核心物理量的定义：</p> <ol> <li> <strong>$z_t$</strong>：在时间 $t$ 时刻的状态（即数据点或噪声点的位置）。</li> <li> <strong>$v(z_t, t)$</strong>：<strong>瞬时速度 (Instantaneous Velocity)</strong>。 <ul> <li>根据定义，它是位置随时间的导数： \(\frac{d z_t}{dt} = v(z_t, t)\)</li> </ul> </li> <li> <strong>$u(z_t, r, t)$</strong>：<strong>平均速度 (Average Velocity)</strong>。 **(注意再注意,这个量是作者定义的!!!) ** <ul> <li>定义为从时间 $r$ 到时间 $t$ 的位移，除以时间间隔 $(t-r)$。</li> <li>数学表达式（论文公式 3）： \(u(z_t, r, t) \triangleq \frac{1}{t - r} \int_r^t v(z_\tau, \tau) d\tau\)</li> </ul> </li> </ol> <p>虽然这里是定义出来的,但实际上也确实是这样.</p> <hr> <h3 id="2-推导过程">2. 推导过程</h3> <p>我们的目标是求出 $u(z_t, r, t)$ 关于时间 $t$ 的全导数 $\frac{d}{dt}$。</p> <h4 id="第一步消除分母转化为积分形式">第一步：消除分母，转化为积分形式</h4> <p>为了方便求导，我们将平均速度的定义式（公式 3）两边同时乘以 $(t - r)$，得到论文中的公式 (4)：</p> \[(t - r) \cdot u(z_t, r, t) = \int_r^t v(z_\tau, \tau) d\tau\] <h4 id="第二步对两边同时关于-t-求全导数">第二步：对两边同时关于 $t$ 求全导数</h4> <p>现在，我们对等式两边分别进行 $\frac{d}{dt}$ 运算。注意，这里我们将 $r$ 视为一个固定的起始时间，不随 $t$ 变化（即 $\frac{dr}{dt} = 0$）。</p> <p><strong>左边求导 (LHS)：应用乘法法则 (Product Rule)</strong> 左边是两个关于 $t$ 的函数的乘积：$f(t) = (t-r)$ 和 $g(t) = u(z_t, r, t)$。 \(\frac{d}{dt} \left[ (t - r) \cdot u(z_t, r, t) \right] = \underbrace{\frac{d}{dt}(t - r)}_{1} \cdot u + (t - r) \cdot \frac{d}{dt} u\) \(\text{LHS} = u(z_t, r, t) + (t - r) \frac{d}{dt} u(z_t, r, t)\)</p> <p><strong>右边求导 (RHS)：应用微积分基本定理 (Fundamental Theorem of Calculus)</strong> 右边是一个变上限积分函数。根据微积分基本定理，对积分上限 $t$ 求导，结果就是被积函数在 $t$ 处的值。 \(\frac{d}{dt} \left[ \int_r^t v(z_\tau, \tau) d\tau \right] = v(z_t, t)\) \(\text{RHS} = v(z_t, t)\)</p> <h4 id="第三步联立等式与整理">第三步：联立等式与整理</h4> <p>将左边和右边相等：</p> \[u(z_t, r, t) + (t - r) \frac{d}{dt} u(z_t, r, t) = v(z_t, t)\] <p>现在，我们将这一项移项，把 $\frac{d}{dt} u$ 留在左边，或者整理成论文公式 (6) 的形式：</p> \[(t - r) \frac{d}{dt} u(z_t, r, t) = v(z_t, t) - u(z_t, r, t)\] <p>进而得到 <strong>MeanFlow Identity</strong>：</p> \[\frac{d}{dt} u(z_t, r, t) = \frac{v(z_t, t) - u(z_t, r, t)}{t - r}\] <hr> <h3 id="3-深入解析全导数-fracddt-u-的展开">3. 深入解析：全导数 $\frac{d}{dt} u$ 的展开</h3> <p>在实际训练神经网络时，我们需要计算左边的 $\frac{d}{dt} u$。这是一个<strong>全导数 (Total Derivative)</strong>，因为 $u$ 依赖于 $z_t$，$r$ 和 $t$，而 $z_t$ 本身又随 $t$ 变化。</p> <p>根据链式法则（Chain Rule）：</p> \[\frac{d}{dt} u(z_t, r, t) = \frac{\partial u}{\partial z_t} \cdot \frac{d z_t}{dt} + \frac{\partial u}{\partial r} \cdot \frac{d r}{dt} + \frac{\partial u}{\partial t} \cdot \frac{d t}{dt}\] <p>代入已知条件：</p> <ol> <li>$\frac{d z_t}{dt} = v(z_t, t)$ （这是瞬时速度的定义）。</li> <li>$\frac{d r}{dt} = 0$ （在求导过程中，$r$ 被视为独立变量）。</li> <li>$\frac{d t}{dt} = 1$。</li> </ol> <p>于是，全导数展开为：</p> \[\frac{d}{dt} u(z_t, r, t) = \underbrace{v(z_t, t) \cdot \nabla_z u}_{\text{对 z 的偏导与速度的点积}} + \underbrace{\frac{\partial u}{\partial t}}_{\text{对 t 的偏导}}\] <p>这正是论文中提到的 <strong>Jacobian-Vector Product (JVP)</strong> 的来源。 在代码实现中，我们计算函数 $u$ 对输入 $(z, r, t)$ 的 Jacobian 矩阵与向量 $(v, 0, 1)$ 的乘积。</p> <hr> <h3 id="4-推导的意义">4. 推导的意义</h3> <p>这个推导之所以重要，是因为它完成了一个看似不可能的任务：</p> <ol> <li> <strong>消除了积分：</strong> 原始定义（公式 3）包含一个积分 $\int$，这在训练中是无法直接计算的（太慢）。</li> <li> <strong>建立了局部联系：</strong> 推导出的恒等式（公式 6）只包含<strong>当前时刻</strong>的变量（$u, v$）和<strong>导数</strong>。</li> <li> <strong>可优化目标：</strong> 它把一个积分问题转化为了一个微分方程求解问题。神经网络只需要去满足这个微分方程（即让 Loss 最小化），就能隐式地学会那个复杂的积分关系。</li> </ol> <p>这就是 MeanFlow 能够从零开始训练（From Scratch）且不需要模拟积分过程的核心数学原理。</p> <h2 id="之前和同事讨论有的会问-在t和r的瞬时速度不都是-x1-x0-吗所以平均速度就是-x1-x0-直接预测它不就行了不就是flow-matching吗">之前和同事讨论,有的会问, 在t和r的瞬时速度不都是 $(x1-x0)$ 吗,所以平均速度就是 $(x1-x0)$, 直接预测它不就行了,不就是flow matching吗</h2> <p>简单来说：<strong>对于单条数据轨迹，是对的；但对于模型学习的整个向量场，是错的。</strong></p> <p>这里涉及到两个核心概念的区别：<strong>条件流 (Conditional Flow)</strong> vs <strong>边缘流 (Marginal Flow)</strong>。 (其实就是论文里的 Figure 2)</p> <h3 id="1-条件流-conditional-flow--直线">1. 条件流 (Conditional Flow) —— 直线</h3> <p>假设我们只看<strong>一张</strong>图片 $x$ 和<strong>一个</strong>对应的噪声 $\epsilon$。 在 Flow Matching 中，我们确实通常把路径设计成直线的： \(z_t = (1-t)x + t\epsilon\) 对这个式子求导，瞬时速度确实是常数： \(v_t = \epsilon - x\) 在这种情况下，无论 $t$ 和 $r$ 是多少，速度都是一样的。平均速度自然也等于瞬时速度。 <strong>如果模型只需要记住这一张图，结论完全成立。</strong></p> <h3 id="2-实际情况边缘流-marginal-flow--曲线">2. 实际情况：边缘流 (Marginal Flow) —— 曲线</h3> <p>但在训练生成模型时，模型面对的是成千上万张图片和无数的噪声。模型不知道当前的 $z_t$ 到底属于哪一张具体的图片 $x$。</p> <p><strong>问题出现在“路径交叉”：</strong> 想象一下，在 $t=0.5$ 的时刻，空间中有一个点 $P$。</p> <ul> <li> <strong>路径 A</strong>（从噪声 $\epsilon_A$ 到图片 $x_A$）经过点 $P$，它的方向是向“左上”。</li> <li> <strong>路径 B</strong>（从噪声 $\epsilon_B$ 到图片 $x_B$）也经过点 $P$，它的方向是向“右上”。</li> </ul> <p>模型在点 $P$ 只能输出<strong>一个</strong>速度向量。它该听谁的？ 根据 Flow Matching 的理论（公式 1），模型学习的是所有经过该点的可能速度的<strong>期望（平均值）</strong>： \(v(z_t, t) = \mathbb{E}[v_t | z_t]\) 在这个例子里，模型会输出“正上方”（左上和右上的平均）。</p> <h3 id="3-结果弯曲的轨迹">3. 结果：弯曲的轨迹</h3> <p>一旦模型输出了平均方向（正上方），生成的轨迹就不再是原来的路径 A（左上），也不是路径 B（右上），而是一条<strong>新的、弯曲的轨迹</strong>。</p> <ul> <li> <strong>论文图 2 (Figure 2) 专门展示了这个现象：</strong> <ul> <li> <strong>左图 (Conditional)：</strong> 每一条单独的线都是直的。</li> <li> <strong>右图 (Marginal)：</strong> 当无数条直线叠加并取平均后，形成的<strong>向量场是弯曲的</strong>。</li> </ul> </li> </ul> <h3 id="4-结论为什么平均速度-neq-瞬时速度">4. 结论：为什么平均速度 $\neq$ 瞬时速度？</h3> <p>因为最终生成的轨迹（Marginal Trajectory）是<strong>弯曲</strong>的：</p> <ol> <li> <strong>瞬时速度 ($v$)：</strong> 是曲线在某一点的<strong>切线</strong>方向。因为曲线在弯，所以切线方向时刻在变。</li> <li> <strong>平均速度 ($u$)：</strong> 是连接起点 $z_r$ 和终点 $z_t$ 的<strong>割线</strong>（直线）方向。</li> </ol> <p><strong>在弯曲的路径上，切线（瞬时）和割线（平均）是不重合的。</strong></p> <h3 id="总结">总结</h3> <ul> <li> <strong>$(x_1 - x_0)$：</strong> 是上帝视角下，连接特定噪声和特定图片的直线速度。</li> <li> <strong>模型学的 $v(z_t, t)$：</strong> 是凡人视角下，在迷雾中看到的众生相的平均方向，这导致路变弯了。</li> <li> <strong>MeanFlow 的 $u$：</strong> 是试图在<strong>弯曲的路径</strong>上，直接找到从起点跳到终点的那个“捷径”向量。</li> </ul> <p>或者:</p> <ol> <li>对于单条数据: $v$ 就是 $ (x1-x0) $, 路径是直的.</li> <li>对于模型学习的目标: $v$ 是无数个 $x_1-x_0$ 的统计平均.</li> </ol> <p>简单回答：<strong>在数学推导的公式里，$v$ 是一个随位置 $z$ 和时间 $t$ 变化的函数 $v(z_t, t)$，而不是常数。</strong> 之所以会觉得它“看起来像” $(x_1 - x_0)$，是因为我们在<strong>构造训练数据</strong>时使用了直线插值。</p> <p>为了解开这个困惑，我们需要区分<strong>“推导时的定义”</strong>和<strong>“训练时的采样”</strong>。</p> <hr> <h3 id="1-推导时的视角v-是一个场-field">1. 推导时的视角：$v$ 是一个场 (Field)</h3> <p>在推导 MeanFlow Identity 时，我们并没有假设粒子走的是直线。</p> <ul> <li> <strong>公式回顾：</strong> \(u(z_t, r, t) = \frac{1}{t-r} \int_r^t v(z_\tau, \tau) d\tau\)</li> <li> <strong>这里的 $v(z_\tau, \tau)$ 是什么？</strong> 它是<strong>边缘速度场 (Marginal Velocity Field)</strong>。 也就是在时间 $\tau$、位置 $z_\tau$ 处，所有可能经过这里的粒子的平均速度。它代表的是我们模型最终想学到的速度场. 正如我们之前讨论的，这个场通常是<strong>弯曲的</strong>， $v$ 随时间 $\tau$ 在不断变化，<strong>它一般不等于常数</strong>。</li> <li> <strong>微积分基本定理：</strong> 推导中用到了 $\frac{d}{dt} \int_r^t v(\tau) d\tau = v(t)$。 这个定理成立的前提<strong>不需要</strong> $v$ 是常数。无论 $v$ 是一条直线还是一条疯狂的曲线，这个导数关系都成立。</li> </ul> <p><strong>结论：</strong> 在公式证明阶段，$v$ 是变量，不是常数 $(x_1 - x_0)$。</p> <hr> <h3 id="2-训练时的视角v-是采样样本-sample">2. 训练时的视角：$v$ 是采样样本 (Sample)</h3> <p>那么，为什么在训练代码里，我们又把 $v$ 当作 $(x_1 - x_0)$ 呢？</p> <p>这是因为我们无法直接获得那个完美的、弯曲的“边缘速度场”。我们只有一堆离散的数据点（图片 $x$ 和噪声 $\epsilon$）。</p> <p>这里用到了 <strong>Flow Matching 的核心原理：期望匹配 (Expectation Matching)</strong>。</p> <ul> <li> <p><strong>理论目标（弯曲的）：</strong> \(\text{Loss} = \| u_\theta - \text{Target}_{\text{Marginal}} \|^2\) 其中 $\text{Target}_{\text{Marginal}}$ 是基于那个弯曲的 $v(z, t)$ 计算出来的。但我们算不出来。</p> </li> <li> <p><strong>实际操作（直线的）：</strong> 我们把 Loss 写成期望形式： \(\text{Loss} \approx \mathbb{E}_{x, \epsilon} [ \| u_\theta - \text{Target}_{\text{Conditional}} \|^2 ]\) 在这里，对于<strong>每一个单独的样本</strong>，我们假定它走直线，所以我们用 $v_{sample} = \epsilon - x$ 代替了公式里的 $v$。</p> </li> </ul> <p><strong>神奇的事情发生了：</strong> 虽然每一个样本提供的 $v_{sample}$ 都是直线的（常数），但因为它们在空间中相互交叉、冲突，神经网络 $u_\theta$ 为了同时让 Loss 最小化，<strong>被迫</strong>去学习所有这些直线的<strong>平均效果</strong>。</p> <p>而这个“平均效果”，恰恰就是那个<strong>弯曲的边缘场</strong>。</p> <hr> <h3 id="3-为什么公式里的导数项不为-0">3. 为什么公式里的导数项不为 0？</h3> <p>回到困惑：</p> <blockquote> <p>“如果 $v$ 是常数，那么 $u$ 也是常数，$\frac{du}{dt}$ 不就是 0 吗？”</p> </blockquote> <p>在训练 Loss 中： \(u_{\text{tgt}} = v_{\text{sample}} - (t-r) \times \frac{d}{dt} u_\theta\)</p> <ol> <li> <strong>$v_{\text{sample}}$：</strong> 确实是常数 $(\epsilon - x)$。</li> <li> <strong>$u_\theta$ (神经网络)：</strong> <strong>它不是常数！</strong> <ul> <li>神经网络 $u_\theta(z, r, t)$ 是一个复杂的非线性函数。</li> <li>当你输入不同的 $z$（即使是沿着直线 $z_t$ 移动），网络的输出 $u_\theta$ 会发生变化。</li> <li>因为网络试图拟合的是那个“弯曲的场”，而不是当前的“直线样本”。</li> <li>所以，<strong>$\frac{d}{dt} u_\theta$ (即 JVP) 不等于 0</strong>。</li> </ul> </li> </ol> <h3 id="总结-1">总结</h3> <ul> <li> <strong>在数学证明里：</strong> $v$ 是边缘场，是变化的，公式描述的是场内部的自洽性。</li> <li> <strong>在训练数据里：</strong> 我们用直线的 $v = \epsilon - x$ 作为<strong>探针</strong>。</li> <li> <strong>在 Loss 计算里：</strong> <ul> <li>$v$ 用的是直线的（常数）。</li> <li>但导数 $\frac{du}{dt}$ 用的是网络的（变化的）。</li> <li> <strong>Loss 的本质是：</strong> 强迫网络预测的“变化率”与“直线样本和网络预测值的偏差”保持一致。当网络在大量样本上都满足这个关系时，它就学会了真正的 MeanFlow。</li> </ul> </li> </ul> <p>模型训练的过程其实就是用个体去估计整体的过程.</p> <ol> <li>个体是直的，整体是弯的 <ul> <li> <strong>个体 (Individual)：</strong> 训练时，每一次迭代我们只采样一对 $(x, \epsilon)$。对于这一对数据，我们假设它们之间是<strong>直线连接</strong>的，速度就是简单的 $v_{sample} = \epsilon - x$。</li> <li> <strong>整体 (Whole)：</strong> 实际上，数据分布是极其复杂的。在空间中的某一点，可能有成千上万条来自不同 $(x, \epsilon)$ 的直线穿过，方向各不相同。</li> <li> <strong>估计过程：</strong> 神经网络 $u_\theta$ 无法同时满足所有冲突的直线方向。为了让总 Loss 最小，它只能被迫去学习这些方向的<strong>期望（平均值）</strong>。</li> </ul> <ul> <li>无数条直线的平均 $\rightarrow$ 变成了一条平滑的曲线（整体场）。</li> </ul> </li> <li>MeanFlow 的独特之处：用“局部”估计“跨度” 普通的 Flow Matching 也是用个体估计整体，但 MeanFlow 更进一步：</li> </ol> <ul> <li> <strong>普通 Flow Matching：</strong> 用个体的“直线方向”去估计整体的“切线方向”。（所以我得一步步走，因为切线在变）。</li> <li> <strong>MeanFlow：</strong> 用个体的“直线方向” + <strong>微分恒等式</strong>，去估计整体的<strong>“一步跨越的平均速度”</strong>。</li> </ul> <p>这就像是：</p> <ul> <li> <strong>个体数据说：</strong> “我现在想沿直线走。”</li> <li> <strong>MeanFlow 恒等式说：</strong> “如果你想一步跳到终点，你现在的变化率必须满足这个物理规律。”</li> <li> <strong>模型说：</strong> “好吧，结合你们俩的要求，我算出了一个能代表整体趋势的‘捷径’。”</li> </ul> <ol> <li>为什么这能行？（大数定律） 虽然每次训练只看一个个体，但在训练了几十万步（Batch Size $\times$ Iterations）之后： <ul> <li>个体的随机性（方差）被平均掉了。</li> <li>留下的就是整体的规律（偏差/均值）。</li> </ul> </li> </ol> <p><strong>MeanFlow 的训练过程，就是通过不断喂给模型无数个“走直线的个体”，利用 Loss 函数的约束，强迫模型在脑海中重构出那个“看不见的、弯曲的整体流场”，并学会如何“一步跨越”它。</strong></p> <p>然后在看公式的时候,一定要明确 哪个量是模型要估计的整体量, 哪个量是要采样出来的个体量. 所以我的理解是平均流恒等式建立了一个宏观速度场与微观粒子的速度的关系. 而且这个微观粒子的速度也是人为定义的,并不是模型学完之后估计出的.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://blog.google/technology/ai/google-gemini-update-flash-ai-assistant-io-2024/" target="_blank" rel="external nofollow noopener">Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://medium.com/@al-folio/displaying-external-posts-on-your-al-folio-blog-b60a1d241a0a?source=rss-17feae71c3c4------2" target="_blank" rel="external nofollow noopener">Displaying External Posts on Your al-folio Blog</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/DriveJEPA/">DriveJEPA</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/C_RADIOv4/">C_RADIOv4</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/GeRo/">GeRo</a> </li> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2026 P W Name. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?v=a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?v=85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?v=c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?v=2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?v=c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?v=c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?v=d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?v=a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?v=2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?v=f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?v=a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?v=6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?v=ccc841c459bfc0e64c1c2b5acd10df02"></script> </body> </html>