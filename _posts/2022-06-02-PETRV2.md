---
layout: post
title: PETRV2
date: 2022-06-02
categories: [Perception]
tags: Perception
---
<!--more-->


- [paper地址](https://arxiv.org/abs/2206.01256)

# PETRv2: A Unified Framework for 3D Perception from Multi-Camera Images


## sketch the main points

PETRv2是一个统一的框架，用于从多视图图像中进行3D感知。基于PETR，PETRv2探索了时间建模的有效性，它利用前一帧的时间信息来提升3D目标检测。更具体地说，扩展了PETR中的3D位置嵌入（3D PE）用于时间建模。3D PE实现了不同帧的对象位置的时间对齐。进一步引入了特征引导的位置编码器，以提高3D PE的数据适应性。
为了支持多任务学习（例如，BEV分割和3D车道检测），PETRv2通过引入特定任务的query提供了一个简单而有效的解决方案，这些query在不同的空间下进行初始化。
PETRv2在3D目标检测、BEV分割和3D车道检测方面实现了最先进的性能。


多摄像机3D目标检测方法可分为基于BEV的[11,12]和基于DETR的[20,24,39]方法。基于BEV的方法（例如，BEVDet[12]）通过LSS[33]将多视图特征显式转换为鸟瞰视图（BEV）表示。与这些基于BEV的不同，基于DETR的方法[39]将每个3D对象建模为object query，并使用匈牙利算法实现端到端建模[16]。在这些方法中，基于DETR[4]的PETR[24]通过添加3D位置嵌入（3D PE）将多视图2D特征转换为3D位置感知特征。从3D空间初始化的object query 可以直接
通过与生成的3D位置感知特征交互来感知3D对象信息。

本文旨在通过使用时间建模和对多任务学习的支持来扩展PETR来构建一个强大且统一的框架。

对于时间建模，主要问题是如何在3D空间中对齐不同帧的对象位置。现有作品[11,20]从特征对齐的角度解决了这个问题。例如，BEVDet4D[11]通过pose变换将前一帧的BEV特征与当前帧显式对齐。然而，PETR将3D位置隐式编码为2D图像特征，并且未能执行显式特征变换。由于PETR已经证明了3D PE（将3D坐标编码为2D特征）在3D感知中的有效性，我们想知道3D PE是否仍然适用于时间对齐。
在PETR中，相机view下的网格点，为不同视图共享，通过相机参数转换为3D坐标。然后将3D坐标输入到简单的多层感知（MLP）中以生成3D PE。在我们的实践中，我们发现PETR只需将前一帧的3D坐标与当前帧对齐就能在时序输入下做得很好


对于多任务学习，BEVForm[20]提供了一个统一的解决方案。它将BEV地图上的每个点定义为一个BEV-query。因此，BEV-query可以用于3D目标检测和BEV分割。然而，当BEV地图的分辨率相对较大（例如256×256）时，BEV-query的数量（例如>60,000）往往会很大。由于transformer中采用的全局attention，这种object query 的定义显然不适合PETR。

本文中设计了一个统一的多任务学习sparse query 解决方案。对于不同的任务，我们定义了不同空间下的稀疏任务特定query。例如，用于3D车道检测的车道查询在3D空间中定义为锚车道样式，而用于BEV分割的seg查询在BEV空间下初始化。这些稀疏的特定任务查询被输入到同一个transformer中以更新它们的表示，并进一步注入不同的特定任务head以产生高质量的预测。


此外，改进了3D PE的生成，并对PETRv2进行了详细的鲁棒性分析。PETR中的3D PE是基于相机空间中的固定网格点生成的。同一个视角下的所有图片共享一个3D PE，使得3D PE并不依赖于数据。在本文中，我们通过引入特征引导位置编码器（FPE）进一步改进了原始3D PE。具体而言，首先将投影的2D特征注入到一个小型MLP网络和一个Sigmoid层中以生成注意力权重，该权重用于以元素方式对3D PE进行重新加权。改进后的3D PE是数据相关的，为变压器解码器中的查询学习提供了信息指导。

BEVForm[20]和BEVDet4D[11]都对齐了BEV空间中的多帧特征。与它们不同的是，我们从PETR扩展了时间版本，并从3D位置嵌入（3D
PE）的角度实现了时间对齐。(我觉得这确实是一个很不同的思路.)

贡献是：
我们研究了位置嵌入变换到时间表示学习的概念上简单的扩展。时间对齐可以通过3D PE上的位姿变换来实现。进一步提出了一种特征引导的位置编码器，在2D图像特征的指导下对3D PE进行重新加权。
为PETR引入了一个简单而有效的解决方案来支持多任务学习。通过引入特定任务的查询来支持BEV分割和3D车道检测。
实验表明，所提出的框架在3D目标检测、BEV分割和3D车道检测上都实现了最先进的性能。还为PETR框架的综合评估提供了详细的鲁棒性分析。
(多任务学习为三网合一奠定了基础.)


流程大致是

1. 由骨干网络从多视图图像中提取2D特征，并按照与PETR相同的方式生成3D坐标[24]。
2. 为了实现时间对齐，首先通过pose变换对前一帧t−1的PETR中的3D坐标进行变换。
然后将两帧的2D图像特征和3D坐标连接在一起并注入特征引导位置编码器，(这样就相当于图像增加了一桢, 坐标也增加了, 而且坐标都是相对于当前桢的,
就相当于petr中的batch变大了一倍.)
3. 就是decoder了. 这部分参考petr, 只不过为了多任务学习，有多个不同的object query.

### 将前一桢的3D坐标与当前桢对齐

用pose即可.

### feature-guided position encoder
